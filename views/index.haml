!!!
%html
  %head
    %title Wyld Wiki Warble
    %link{:rel => 'stylesheet', :href => 'style.css', :type => 'text/css'}
    %script{:src => 'jquery.js', :type => 'text/javascript'}
    %script{:type => 'text/javascript'}
      :plain
        var words = {};
        var word_counter = 0;
        var initial_words = {'Warble': '[Knowledge] in 140 characters or less'};
        var linkify = /[\[\]]/g;

        function check(a_tag) {
          console.log(a_tag);
          return false;
        }

        function recount(e) {
          var length = document.getElementById('data').value.length;
          $('#remaining')
            .html(length)
            .toggleClass('warning', 130 < length && length <= 140)
            .toggleClass('error', 140 < length);
        }

        function replace_brace(match) {
          if(match == '['){
            return '[<a href="#" onclick="javascript:check(this);">';
          }
          return '</a>]';
        }

        function parse_links(definition) {
          definition = definition.replace(linkify, replace_brace);
          return jQuery.trim(definition);
        }

        function load_word(word, definition) {
          if(words[word] == undefined) {
            var word_id = 'word_' + word_counter;
            word_counter++;
            var new_concept = $('.sample').clone()
              .removeClass('sample')
              .insertAfter('.sample')
              .attr('id', word_id)
              .mouseover(function() { $('#'+word_id).addClass('highlight'); })
              .mouseout(function() { $('#'+word_id).removeClass('highlight'); })
              .click(function() { edit($('#'+word_id)); })
              .children('dt').text(word).end();

            var dd = new_concept.children('dd');
          } else {
            dd = words[word];
          }
          dd.html(parse_links(definition));
          words[word] = dd;
        }

        function edit(dd) {
          var data = document.getElementById('data');
          var word = dd.children('dt').text();
          var definition = dd.children('dd').text();
          data.value = word + ':' + definition;
          recount();
        }

        function add_definition(e) {
          if(e.keyCode == 13) {
            var text = document.getElementById('data').value;
            var i = text.search(':');
            if(i > 0 && text.length - i > 1) {
              var word = text.substr(0, i);
              var definition = text.substr( i+1 );

              load_word(word, definition);
            
              //TODO Send to server via AJAJ

              //TODO Update if a visible definition
              //console.log('w '+word+' d '+definition);


              document.getElementById('data').value = '';
            }
            e.preventDefault();
          }
        }

        $(document).ready(function() {
          $('#data')
            .keyup(recount)
            .keydown(add_definition)
            .focus();
          recount();

          for(var w in initial_words) {
            load_word(w, initial_words[w]);
          }
        });
  %body
    .top
    %h1 Warble (11)
    #content
      .left
      .main
        %div
          %div
            (
            %span#remaining.countdown 29
            )
        %textarea#data Your goal: Spread wisdom
        %dl#sample.sample
          %hr
          %dt 
          %dd
        #history
      .right
    .bottom
      %p Knowledge Management meets Wiki + Twitter. (47)
